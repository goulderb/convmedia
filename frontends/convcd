#!/bin/sh

export TMPDIR="/tmp/convcd"
export INCDIR="/usr/local/share/convmedia/includes"
export CD_DEVICE="/dev/cdrom"
export AQUALITY="3"
export ACODEC="vorbis"
export FILE_MASK="%TRACKNUM - %TITLE"
export DIR_MASK="%ALBUM"
export EJECT="1"

if [ ! -d $TMPDIR ]; then
	mkdir $TMPDIR
else
	rm -rf $TMPDIR
	mkdir $TMPDIR
fi

if [ -f /etc/convmedia/convcd.conf ]; then
	source /etc/convmedia/convcd.conf
else
	echo "Can't load configuration, exiting."
	exit 1
fi

if [ -f $INCDIR/generic-functions.shlib -a -f $INCDIR/container-functions.shlib -a -f $INCDIR/audio-functions.shlib ]; then
	source $INCDIR/generic-functions.shlib
	source $INCDIR/container-functions.shlib
	source $INCDIR/audio-functions.shlib
else
	echo "Can't load functions, exiting."
	exit 1
fi

help() {
	echo "convcd: An extra-sane audio CD ripper."
	echo
	echo "Usage: $0 [OPTIONS]"
	echo
	echo "Supported audio formats: vorbis, mp3, aac-lc, aac-main, aac-ltp, aac-hev1, aac-hev2, flac"
	echo
	echo "Options:"
	echo "-f: Format you want the CD to be ripped to."
	echo "-q: Encoding quality, highest quality is 10, lowest is 1."
	echo "-a: Audio filters to use."
	echo "-r: Resample input audio to the specified sampling rate, such as 44100."
	echo "-n: When encoding to AAC-LC, prefer Nero's encoder over faac if available."
	echo "-d: CD-Rom device node to use."
	echo "-i: Interactive mode, convcd may prompt you to change certain things, such as metadata."
	echo "-b: Enable debugging mode (set -e -x)."
	echo "-h: Print this help."
	exit 0
}

while getopts 'f:a:q:r:d:nbhi' z; do
	case "$z" in
	f)
		export ACODEC="$OPTARG"
	;;
	a)
		export AF="-af $OPTARG"
	;;
	q)
		export AQUALITY="$OPTARG"
	;;
	d)
		export CD_DEVICE="$OPTARG"
	;;
	b)
		set -e -x
	;;
	r)
		export RESAMPLE="$OPTARG"
	;;
	n)
		export USENEROAAC="1"
	;;
	i)
		export INTERACTIVE="1"
	;;
	h)
		help
	;;
 esac
done
shift $(($OPTIND-1))

if [ -z $ACODEC ]; then
	help
fi

if [ -n "$RESAMPLE" -a -n "$AF" ]; then
	local AF="$AF,lavcresample=$RESAMPLE"
	export MPLAYER_OPTS="$MPLAYER_OPTS -srate $RESAMPLE $AF"
elif [ -n "$RESAMPLE" -a -z "$AF" ]; then
	local AF="-af lavcresample=$RESAMPLE"
	export MPLAYER_OPTS="$MPLAYER_OPTS -srate $RESAMPLE $AF"
elif [ -z "$RESAMPLE" -a -n "$AF" ]; then
	export MPLAYER_OPTS="$MPLAYER_OPTS $AF"
fi

export PARANOIA_OPTS="--never-skip=40 -d $CD_DEVICE"
export CDDBQUERY_OPTS="-i $CD_DEVICE"

cddb_extract_info
if [ -n "$INTERACTIVE" ]; then
	echo -n "Do you want to edit the song titles, artist(s) and album name information now? (y/n) "; read answer
	if [ "$answer" = "y" ]; then
		$EDITOR ${TMPDIR}/songs.txt
		$EDITOR ${TMPDIR}/artists.txt
		$EDITOR ${TMPDIR}/title.txt
	fi
fi

for i in `seq $TRACKS`; do
	if [ ! "`echo "$i" | wc -m`" = 3 ]; then
		export N="0${i}"
	else
		export N="$i"
	fi

	# Export title/artist/album/tracknum, then change FILE_MASK accordingly.
	export TITLE="`grep ${N}: ${TMPDIR}/songs.txt | cut -d: -f2`"
	export ARTIST="`grep ${N}: ${TMPDIR}/artists.txt | cut -d: -f2`"
	export ALBUM="`cat ${TMPDIR}/title.txt`"
	export TRACKNUM="$N"
	export ORIG_FMASK="$FILE_MASK"
	export ORIG_DMASK="$DIR_MASK"
	export FILE_MASK="`echo "$FILE_MASK" | sed "s:%TITLE:$TITLE:g" | sed "s:%ARTIST:$ARTIST:g" | sed "s:%ALBUM:$ALBUM:g" | sed "s:%TRACKNUM:$TRACKNUM:g"`"
	export DIR_MASK="`echo "$DIR_MASK" | sed "s:%TITLE:$TITLE:g" | sed "s:%ARTIST:$ARTIST:g" | sed "s:%ALBUM:$ALBUM:g" | sed "s:%TRACKNUM:$TRACKNUM:g"`"

	if [ ! -d "$DIR_MASK" ]; then
		mkdir -p "$DIR_MASK"
	fi

	cdparanoia_extract $i
	mv "${TMPDIR}/cdda.wav" "${TMPDIR}/$FILE_MASK.wav"

	case $ACODEC in
	vorbis)
		echo "Encoding ${FILE_MASK}.wav to ${ACODEC}..."
		audio_encode $ACODEC "${TMPDIR}/${FILE_MASK}.wav" "${DIR_MASK}/${FILE_MASK}.ogg"
		echo "Setting metatags for ${DIR_MASK}/${FILE_MASK}.ogg"
		set_common_metatags ogg "${DIR_MASK}/${FILE_MASK}.ogg"
		echo
		rm "${TMPDIR}/${FILE_MASK}.wav"
	;;
	aac-*)
		echo "Encoding ${FILE_MASK}.wav to ${ACODEC}..."
		audio_encode $ACODEC "${TMPDIR}/${FILE_MASK}.wav" "${DIR_MASK}/${FILE_MASK}.mp4"
		echo "Setting metatags for ${DIR_MASK}/${FILE_MASK}.mp4"
		set_common_metatags mp4 "${DIR_MASK}/${FILE_MASK}.mp4"
		echo
		rm "${TMPDIR}/${FILE_MASK}.wav"
	;;
	mp3)
		echo "Encoding ${FILE_MASK}.wav to ${ACODEC}..."
		audio_encode $ACODEC "${TMPDIR}/${FILE_MASK}.wav" "${DIR_MASK}/${FILE_MASK}.mp3"
		echo "Setting metatags for ${DIR_MASK}/${FILE_MASK}.mp3"
		set_common_metatags id3 "${DIR_MASK}/${FILE_MASK}.mp3"
		echo
		rm "${TMPDIR}/${FILE_MASK}.wav"
	;;
	flac)
		echo "Encoding ${FILE_MASK}.wav to ${ACODEC}..."
		audio_encode $ACODEC "${TMPDIR}/${FILE_MASK}.wav" "${DIR_MASK}/${FILE_MASK}.flac"
		echo "Setting metatags for ${DIR_MASK}/${FILE_MASK}.flac"
		set_common_metatags flac "${DIR_MASK}/${FILE_MASK}.flac"
		echo
		rm "${TMPDIR}/${FILE_MASK}.wav"
	;;
	esac
	export FILE_MASK="$ORIG_FMASK"
	export DIR_MASK="$ORIG_DMASK"
done

rm -rf "$TMPDIR"
if [ -n "$EJECT" ]; then
	eject "$CD_DEVICE"
fi
